<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konobar - The Black Turtle</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }

        body {
            padding-top: 0;
            margin-top: 0;
        }
        
        .menu-panel {
            flex: 2;
            padding: 20px;
            background-color: #f5f5f5;
            overflow-y: auto;
        }
        
        .order-panel {
            flex: 1;
            padding: 20px;
            background-color: #f5f5f5;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        .category-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .category-tab {
            text-align: center;
            padding: 10px 5px;
            cursor: pointer;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
            transition: all 0.2s ease;
        }

        .category-tab:hover {
            background-color: #f0f0f0;
        }

        .category-tab.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .menu-dropdown {
            position: relative;
            display: inline-block;
        }

        .menu-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 4px;
            z-index: 1001;
            border: 1px solid #ddd;
            margin-top: 5px;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content a:first-child {
            border-radius: 4px 4px 0 0;
        }

        .dropdown-content a:last-child {
            border-radius: 0 0 4px 4px;
        }

        .dropdown-content.show {
            display: block;
        }
        
        .menu-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .item-price {
            color: #777;
        }
        
        .order-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .order-items {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
        }
        
        .order-item {
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .order-item-name {
            flex: 1;
        }
        
        .order-item-controls {
            display: flex;
            align-items: center;
        }
        
        .btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: #f5f5f5;
            cursor: pointer;
            margin: 0 5px;
            font-size: 18px;
        }
        
        .remove-btn {
            color: #e74c3c;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            height: 40px;
        }
        
        .order-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            background-color: #f5f5f5; 
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        button.send-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 12px;
        }
        
        button.send-btn:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        
        .message-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #4CAF50;
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1000;
            display: none;
        }
        
        .message-bar.error {
            background: #e74c3c;
        }
        
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-size: 12px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .empty-message {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .suboptions-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .suboption-item {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
        }

        .suboption-item:last-child {
            border-bottom: none;
        }

        .suboption-item:hover {
            background-color: #f9f9f9;
        }

        html, body {
            overflow-x: hidden;
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        #tableAreaSelect, #tableSelect {
            height: 40px;  /* Increased from default */
            padding: 12px 15px;  /* More padding for better touch targets */
            font-size: 16px;  /* Larger text */
            margin-bottom: 12px;  /* More space between elements */
        }

        /* Add this to your style section */
        .comment-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin: 0 5px;
            width: 30px;
            height: 30px;
        }

        .item-comment {
            font-size: 12px;
            font-style: italic;
            color: #666;
            margin-top: 3px;
            background-color: #f9f9f9;
            padding: 3px 6px;
            border-radius: 3px;
        }

        .comment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .comment-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .comment-modal-header {
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .comment-close {
            cursor: pointer;
            font-size: 20px;
        }

        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-family: Arial, sans-serif;
            font-size: 16px; /* Minimum size to prevent auto-zoom */
            line-height: 1.4;
        }

        .comment-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .comment-save, .comment-cancel {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .comment-save {
            background-color: #4CAF50;
            color: white;
            border: none;
        }

        .comment-cancel {
            background-color: #f1f1f1;
            border: 1px solid #ddd;
        }

        .header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-weight: bold;
            font-size: 20px;
        }
        
        .order-stats {
            display: flex;
            gap: 15px;
        }
        
        .stat-box {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            min-width: 80px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-badge {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin-right: 15px;
        }
        
        .logout-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 768px) {

            .comment-textarea {
                font-size: 18px; /* Larger font for mobile */
                padding: 15px;
                min-height: 120px;
            }
            
            .comment-modal-content {
                width: 95%;
                padding: 25px;
            }
            
            .comment-modal-header {
                font-size: 18px;
                margin-bottom: 20px;
            }
            
            .comment-save, .comment-cancel {
                padding: 12px 20px;
                font-size: 16px;
            }

            body {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow-x: hidden;
            }

            .menu-panel, .order-panel {
                flex: none;
                width: 100%;
                max-width: 100%;
                padding: 10px;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            /* Make buttons larger for touch */
            .btn, .send-btn, select {
                min-height: 44px; /* Minimum touch target size */
                font-size: 16px; /* Prevent iOS zoom on focus */
            }
            
            /* Fix for order items */
            .order-item {
                width: 100%;
                box-sizing: border-box;
            }
            
            .category-tabs {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 5px;
            }
            
            .category-tab {
                font-size: 14px;
                padding: 8px 4px;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }

            .menu-item {
                padding: 10px;
                font-size: 14px;
            }

            .order-title {
                font-size: 18px;
            }


            .order-item-controls {
                margin-top: 5px;
            }

            select, button {
                font-size: 14px;
                padding: 8px;
            }

            .message-bar {
                font-size: 14px;
                padding: 8px;
            }
            .order-items {
                flex: 0 0 auto;
                overflow-y: visible;
                max-height: none;
                margin-bottom: 15px;
            }
            
            /* Make order panel fully scrollable */
            .order-panel {
                overflow-y: auto;
                height: auto;
                max-height: none;
            }
            
            /* Ensure the order footer stays visible */
            .order-footer {
                position: sticky;
                bottom: 0;
                background: #f5f5f5; 
                padding-top: 10px;
                margin-top: 10px;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            }
        }

        /* Adjust grid layout for smaller screens */
        @media (max-width: 480px) {
            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .menu-item {
                font-size: 12px;
                padding: 8px;
            }

            body {
                font-size: 14px;
            }

            .item-name, .item-price {
                font-size: 12px;
            }

            .order-title {
                font-size: 16px;
            }

            .order-item-name {
                font-size: 14px;
            }

            .category-tabs {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 4px;
            }
            
            .category-tab {
                font-size: 12px;
                padding: 6px 3px;
            }
        }   

    </style>
</head>
<body>
    <header class="header">
        <div class="order-stats">
            <div class="stat-box">
                <div class="stat-value" id="sentOrdersCount">0</div>
                <div class="stat-label">Poslata</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="preparedOrdersCount">0</div>
                <div class="stat-label">Spremna</div>
            </div>
        </div>
        <div class="user-info">
            <div class="menu-dropdown">
                <button class="menu-btn" id="menuBtn" onclick="toggleMenu()">⋯</button>
                <div class="dropdown-content" id="dropdownContent">
                    <a href="#" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </header>
    <div id="messageBar" class="message-bar"></div>
    
    <div class="menu-panel">
        <div class="category-tabs">
            <div class="category-tab active" data-category="toceno">Točena piva</div>
            <div class="category-tab" data-category="flasa">Piva u flaši</div>
            <div class="category-tab" data-category="vina">Vina</div>
            <div class="category-tab" data-category="rakija">Rakija</div>
            <div class="category-tab" data-category="zestina">Žestina</div>
            <div class="category-tab" data-category="toplo">Kafe i čajevi</div>
            <div class="category-tab" data-category="voda">Voda</div>
            <div class="category-tab" data-category="sokovi">Sokovi</div>
            <div class="category-tab" data-category="cedjeno">Ceđeni sokovi</div>
            <div class="category-tab" data-category="supe">Supe u šolji</div>
            <div class="category-tab" data-category="grickalice">Grickalice</div>
        </div>
        
        <div class="menu-grid" id="menuGrid"></div>
    </div>
    
    <div class="order-panel">
        <div class="order-title">Current Order</div>
        
        <div class="order-items" id="orderItems">
            <div class="empty-message" id="emptyMessage">No items added yet</div>
        </div>
        
        <div class="order-footer">
            <div class="order-total">
                <span>Ukupno:</span>
                <span id="totalAmount">RSD0.00</span>
            </div>

            <select id="tableAreaSelect">
                <option value="">Izaberi polje</option>
                <option value="basta-reka">Bašta - reka</option>
                <option value="basta-zid">Bašta zid</option>
                <option value="unutra">Unutra</option>

            </select>
            
            <select id="tableSelect" style="display: none;">
                <option value="">Izaberi sto</option>
            </select>
            
            <button class="send-btn" id="sendOrderBtn" disabled>Pošalji porudžbinu</button>
        </div>

        <div class="todays-orders-section" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
            <div class="todays-orders-title" style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333;">Današnje porudžbine</div>
            <div id="todaysOrdersList" class="todays-orders-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; background-color: white; padding: 10px;">
                <div style="text-align: center; padding: 20px; color: #666;">Učitavanje...</div>
            </div>
        </div>
    </div>
    
    <script src="/config.js"></script>
    <script>
        // Check if CONFIG is defined
        if (typeof CONFIG === 'undefined') {
            console.error('CONFIG is not defined. Please ensure config.js is loaded correctly.');
        } else {
            debug('CONFIG loaded:', CONFIG);
        }
        console.log('baserUrl:', CONFIG.baseUrl);
        console.log('domain:', CONFIG.domain);
        console.log('port:', CONFIG.port);

        const tableMappings = {
            'basta-reka': [
                {value: '41', label: 'Table 41'},
                {value: '42', label: 'Table 42'},
                {value: '43', label: 'Table 43'},
                {value: '44', label: 'Table 44'},
                {value: '45', label: 'Table 45'},
                {value: '46', label: 'Table 46'},
                {value: '51', label: 'Table 51'},
                {value: '52', label: 'Table 52'},
                {value: '53', label: 'Table 53'},
                {value: '54', label: 'Table 54'},
                {value: '55', label: 'Table 55'},
                {value: '56', label: 'Table 56'}
            ],
            'basta-zid': [
                {value: '61', label: 'Table 61'},
                {value: '62', label: 'Table 62'},
                {value: '63', label: 'Table 63'},
                {value: '64', label: 'Table 64'},
                {value: '65', label: 'Table 65'},
                {value: '66', label: 'Table 66'},
                {value: '67', label: 'Table 67'},
                {value: '68', label: 'Table 68'},
                {value: '69', label: 'Table 69'},
                {value: '70', label: 'Table 70'},
                {value: '71', label: 'Table 71'},
                {value: '72', label: 'Table 72'},
                {value: '73', label: 'Table 73'},
                {value: '74', label: 'Table 74'},
                {value: '75', label: 'Table 75'},
                {value: '76', label: 'Table 76'},
                {value: '77', label: 'Table 77'},
                {value: '78', label: 'Table 78'}
            ],
            'unutra': [
                {value: '1', label: 'Table 1'},
                {value: '2', label: 'Table 2'},
                {value: '3', label: 'Table 3'},
                {value: '4', label: 'Table 4'},
                {value: '5', label: 'Table 5'},
                {value: '6', label: 'Table 6'},
                {value: '7', label: 'Table 7'},
                {value: '8', label: 'Table 8'},
                {value: '9', label: 'Table 9'},
                {value: '10', label: 'Table 10'},
                {value: '11', label: 'Table 11'},
                {value: '12', label: 'Table 12'},
                {value: '13', label: 'Table 13'},
                {value: '14', label: 'Table 14'},
                {value: '15', label: 'Table 15'},
                {value: '16', label: 'Table 16'},
                {value: '17', label: 'Table 17'},
                {value: '18', label: 'Table 18'},
                {value: '19', label: 'Table 19'},
                {value: '20', label: 'Table 20'},
                {value: '21', label: 'Table 21'},
                {value: '22', label: 'Table 22'},
                {value: '23', label: 'Table 23'},
                {value: '24', label: 'Table 24'},
                {value: '25', label: 'Table 25'},
                {value: '26', label: 'Table 26'},
                {value: '27', label: 'Table 27'},
                {value: '28', label: 'Table 28'},
                {value: '29', label: 'Table 29'},
                {value: '30', label: 'Table 30'},
                {value: '31', label: 'Table 31'},
                {value: '32', label: 'Table 32'},
                {value: '33', label: 'Table 33'},
                {value: '34', label: 'Table 34'},
                {value: '35', label: 'Table 35'},
                {value: '36', label: 'Table 36'},
                {value: '37', label: 'Table 37'},
                {value: '38', label: 'Table 38'},
                {value: '39', label: 'Table 39'},
                {value: '40', label: 'Table 40'}
            ]
        };

        // Menu data
        const menuData = {
            toceno: [
                    { id: 't1', name: 'Svetlo 0.3', price: 280.00, color: '#009900' },  // More Irish green for light beer
                    { id: 't2', name: 'Tamno 0.3', price: 280.00, color: '#5D2906' },   // Darker brown for dark beer
                    { id: 't3', name: 'Svetlo 0.5', price: 340.00, color: '#009900' },
                    { id: 't4', name: 'Tamno 0.5', price: 340.00, color: '#5D2906' },
                    { id: 't5', name: 'Svetlo 1l', price: 640.00, color: '#009900' },
                    { id: 't6', name: 'Tamno 1l', price: 640.00, color: '#5D2906' },
                    { id: 't7', name: 'Borovnica 0.3', price: 280.00, color: '#8A2BE2' },  // Lighter purple for blueberry
                    { id: 't8', name: 'Jagoda 0.3', price: 280.00, color: '#FF3355' },     // More reddish for strawberry
                    { id: 't9', name: 'Borovnica 0.5', price: 340.00, color: '#8A2BE2' },
                    { id: 't10', name: 'Jagoda 0.5', price: 340.00, color: '#FF3355' },
                    { id: 't11', name: 'Borovnica 1l', price: 640.00, color: '#8A2BE2' },
                    { id: 't12', name: 'Jagoda 1l', price: 640.00, color: '#FF3355' },
                    { id: 't13', name: 'Sezonsko 0.3', price: 280.00, color: '#FF8C00' },  // More vibrant orange for seasonal
                    { id: 't14', name: 'Kronenberg 0.3', price: 300.00, color: '#4682B4' }, // Lighter sea blue for Kronenberg
                    { id: 't15', name: 'Sezonsko 0.5', price: 340.00, color: '#FF8C00' },
                    { id: 't16', name: 'Kronenberg 0.5', price: 500.00, color: '#4682B4' },
                    { id: 't17', name: 'Sezonsko 1l', price: 640.00, color: '#FF8C00' },
                    { id: 't18', name: 'Kronenberg 1.0', price: 1000.00, color: '#4682B4' },
                    { id: 't19', name: 'Asahi 0.3', price: 300.00, color: '#FFFFFF' },    // White for Asahi (unchanged)
                    { id: 't20', name: 'Asahi 0.5', price: 500.00, color: '#FFFFFF' },
                    { id: 't21', name: 'Asahi 1.0', price: 1000.00, color: '#FFFFFF' }
                ],
            flasa: [
                { id: 'f1', name: 'Lav Premium 0.33', price: 330.00 },
                { id: 'f2', name: 'Carlsberg 0.33', price: 390.00 },
                { id: 'f3', name: 'Kronenberg 0.33', price: 360.00 },
                { id: 'f4', name: 'Erdinger 0.33', price: 450.00 },
                { id: 'f5', name: 'Somersby 0.33', price: 420.00 },
                { id: 'f6', name: 'Pilsner 0.5', price: 450.00 },
                { id: 'f7', name: 'Kozel svetli 0.5', price: 450.00 },
                { id: 'f8', name: 'Kozel tamni 0.5', price: 450.00 },
                { id: 'f9', name: 'Asahi 0.5', price: 450.00 }
            ],
            vina: [
                { id: 'v1', name: 'Chardonney', price: 400.00 },
                { id: 'v2', name: 'Rose', price: 400.00 },
                { id: 'v3', name: 'Vranac', price: 400.00 },
                { id: 'v4', name: 'Kuvano', price: 290.00 }
            ],
            rakija: [
                { id: 'r1', name: 'Dunja', price: 320.00 },
                { id: 'r2', name: 'Viljamovka', price: 320.00 },
                { id: 'r3', name: 'Kajsija', price: 320.00 },
                { id: 'r4', name: 'Šljiva', price: 300.00 },
                { id: 'r5', name: 'Medovača', price: 280.00 },
                { id: 'r6', name: 'Medena malina', price: 280.00 }
            ],
            zestina: [
                { id: 'z1', name: 'Chivas Regal', price: 500.00 },
                { id: 'z2', name: 'Tullamore Dew', price: 350.00 },
                { id: 'z3', name: 'Johnnie Walker', price: 320.00 },
                { id: 'z4', name: 'Ballantines', price: 320.00 },
                { id: 'z5', name: 'Jack Daniels', price: 410.00 },
                { id: 'z6', name: 'Jameson', price: 350.00 },
                { id: 'z7', name: 'Four Roses', price: 350.00 },
                { id: 'z8', name: 'Absolut Vodka', price: 320.00 },
                { id: 'z9', name: 'Bacardi', price: 320.00 },
                { id: 'z10', name: 'Beefetter gin', price: 330.00 },
                { id: 'z11', name: 'Tequila', price: 320.00 },
                { id: 'z12', name: 'Amaretto Disarono', price: 320.00 },
                { id: 'z13', name: 'Amaro Montenegro', price: 320.00 },
                { id: 'z14', name: 'Jagermeister', price: 320.00 },
                { id: 'z15', name: 'Campari', price: 320.00 },
                { id: 'z16', name: 'Ramazzotti', price: 320.00 },
                { id: 'z17', name: 'Martini', price: 320.00 },
                { id: 'z18', name: 'Ouzo', price: 320.00 },
                { id: 'z19', name: 'Pelinkovac', price: 280.00 },
                { id: 'z20', name: 'Vinjak', price: 280.00 },
                { id: 'z21', name: 'Aperol', price: 370.00 },
                { id: 'z22', name: 'Aperol Spritz', price: 600.00 }
            ],
            toplo: [
                { id: 'k1', name: 'Kratki espresso', price: 210.00 },
                { id: 'k2', name: 'Produženi espresso', price: 210.00 },
                { id: 'k3', name: 'Espresso sa toplim mlekom', price: 240.00 },
                { id: 'k4', name: 'Espresso sa hladnim mlekom', price: 240.00 },
                { id: 'k5', name: 'Kapućino', price: 280.00 },
                { id: 'k6', name: 'Machiatto', price: 240.00 },
                { id: 'k7', name: 'XL Espresso sa mlekom', price: 420.00 },
                { id: 'k8', name: 'Espresso fredo', price: 360.00 },
                { id: 'k9', name: 'Caffe latte', price: 320.00 },
                { id: 'k10', name: 'Hladni nes', price: 280.00 },
                { id: 'k11', name: 'Topli nes', price: 280.00 },
                { id: 'k12', name: 'Domaća kafa', price: 200.00 },
                { id: 'k13', name: 'Topla čokolada', price: 320.00, suboptions: [
                    { id: 'k13-1', name: 'Crna', price: 0.00 },
                    { id: 'k13-2', name: 'Crna sa narandžom', price: 0.00 },
                    { id: 'k13-3', name: 'Bela sa lešnikom', price: 0.00 } 
                ]},
                { id: 'k14', name: 'Čaj', price: 210.00, suboptions: [
                    { id: 'k14-1', name: 'Kamilica', price: 0.00 },
                    { id: 'k14-2', name: 'Nana', price: 0.00 },
                    { id: 'k14-3', name: 'Hibiskus', price: 0.00 },
                    { id: 'k14-4', name: 'Zeleni', price: 0.00 },
                    { id: 'k14-5', name: 'Vonćni', price: 0.00 },
                    { id: 'k14-6', name: 'Crni', price: 0.00 },
                    { id: 'k14-7', name: 'Zimski', price: 0.00 }
                ] },
                { id: 'k15', name: 'Ronnefeldt LeafCup', price: 280.00 },
                { id: 'k16', name: 'Med', price: 40.00 },
                { id: 'k19', name: 'Sojino Mleko', price: 110.00 },
                { id: 'k20', name: 'Šlag', price: 110.00 }
            ],
            voda: [
                { id: 'a1', name: 'Aqua Viva 0,25l', price: 210.00 },
                { id: 'a2', name: 'Aqua Viva 1l', price: 390.00 },
                { id: 'a3', name: 'Voda Voda 0,75l', price: 390.00 },
                { id: 'a4', name: 'Knjaz Miloš 0.25l', price: 210.00 }
            ],
            sokovi: [
                { id: 's1', name: 'Orangina', price: 350.00 },
                { id: 's2', name: 'Cockta', price: 280.00 },
                { id: 's3', name: 'Pepsi', price: 280.00 },
                { id: 's4', name: 'Pepsi max', price: 280.00 },
                { id: 's5', name: 'Mirinda', price: 280.00 },
                { id: 's6', name: '7UP', price: 280.00 },
                { id: 's7', name: 'Bitter lemon', price: 280.00 },
                { id: 's8', name: 'Tonic', price: 280.00 },
                { id: 's9', name: 'Bravo sok flašica', price: 330.00, suboptions: [
                    { id: 's9-1', name: 'Narandža', price: 0.00 },
                    { id: 's9-2', name: 'Breskva', price: 0.00 },
                    { id: 's9-3', name: 'Jabuka', price: 0.00 },
                    { id: 's9-4', name: 'Jagoda', price: 0.00 },
                    { id: 's9-5', name: 'Crna ribizla', price: 0.00 }
                ]},
                { id: 's10', name: 'Cedevita', price: 300.00 },
                { id: 's11', name: 'Guarana', price: 300.00 }
            ],
            cedjeno: [
                { id: 'c1', name: 'Limunada', price: 330.00 },
                { id: 'c2', name: 'Ceđena pomorandža', price: 380.00 },
                { id: 'c3', name: 'Ceđeni grejp', price: 410.00 },
                { id: 'c4', name: 'Ceđeni mix', price: 430.00 }
            ],
            supe: [
                { id: 'm1', name: 'Pileća', price: 190.00 },
                { id: 'm2', name: 'Povrće', price: 190.00 },
                { id: 'm3', name: 'Paradajz', price: 190.00 },
                { id: 'm4', name: 'Pečurke', price: 190.00 },
                { id: 'm5', name: 'Nudle piletina', price: 220.00 },
                { id: 'm6', name: 'Nudle povrće', price: 220.00 },
                { id: 'm7', name: 'Nudle govedina', price: 220.00 }
            ],
            grickalice: [
                { id: 'g1', name: 'Kikiriki', price: 110.00 },
                { id: 'g2', name: 'Mali čips', price: 110.00 },
                { id: 'g3', name: 'Veliki čips', price: 210.00 },
                { id: 'g4', name: 'Kokice', price: 180.00 },
                { id: 'g4', name: '7 Days kroasan', price: 110.00 }
            ]
        };
        
        // Current order
        let currentOrder = [];
        
        // Debug function
        function debug(message) {
            const debugEl = document.getElementById('debug');
            const now = new Date().toLocaleTimeString();
            
            console.log(`[${now}] ${message}`);
            
            if (debugEl) {
                debugEl.innerHTML += `[${now}] ${message}<br>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }
        
        // Show message
        function showMessage(message, isError = false) {
            try {
                const messageBar = document.getElementById('messageBar');
                if (!messageBar) return;
                
                messageBar.textContent = message;
                
                if (isError) {
                    messageBar.classList.add('error');
                } else {
                    messageBar.classList.remove('error');
                }
                
                messageBar.style.display = 'block';
                
                setTimeout(() => {
                    messageBar.style.display = 'none';
                }, 3000);
                
                debug(`Message: ${message} (${isError ? 'error' : 'success'})`);
            } catch (err) {
                debug(`Error showing message: ${err.message}`);
                try {
                    alert(isError ? 'Error: ' + message : message);
                } catch (e) {
                    // Last resort
                    debug('Failed to show any notification');
                }
            }
        }
        
        // Load menu items
        function loadMenuItems(category) {
            const grid = document.getElementById('menuGrid');
            grid.innerHTML = '';

            menuData[category].forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'menu-item';
                
                // Apply custom color if available
                if (category === 'toceno' && item.color) {
                    itemEl.style.backgroundColor = item.color;
                    
                    // Determine if text should be white or black based on background brightness
                    const r = parseInt(item.color.substring(1, 3), 16);
                    const g = parseInt(item.color.substring(3, 5), 16);
                    const b = parseInt(item.color.substring(5, 7), 16);
                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                    
                    // Use white text for dark backgrounds, black text for light backgrounds
                    const textColor = brightness < 128 ? 'white' : 'black';
                    itemEl.style.color = textColor;
                    
                    itemEl.innerHTML = `
                        <div class="item-name">${item.name}</div>
                        <div class="item-price" style="color: inherit;">RSD${item.price.toFixed(2)}</div>
                    `;
                } else {
                    itemEl.innerHTML = `
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">RSD${item.price.toFixed(2)}</div>
                    `;
                }

                itemEl.addEventListener('click', (event) => {
                    // Only process clicks if no suboptions are open
                    if (!isSuboptionsOpen) {
                        if (item.suboptions) {
                            showSuboptions(item);
                        } else {
                            addToOrder(item);
                        }
                    }
                });

                grid.appendChild(itemEl);
            });

            debug(`Loaded ${menuData[category].length} items for category: ${category}`);
        }
        let isSuboptionsOpen = false;

        // Show suboptions
        function showSuboptions(item) {
            // Set flag to indicate suboptions are open
            isSuboptionsOpen = true;
            
            const suboptionsContainer = document.createElement('div');
            suboptionsContainer.className = 'suboptions-container';

            item.suboptions.forEach(suboption => {
                const suboptionEl = document.createElement('div');
                suboptionEl.className = 'suboption-item';

                suboptionEl.innerHTML = `
                    <div class="suboption-name">${suboption.name}</div>
                    <div class="suboption-price">+RSD${suboption.price.toFixed(2)}</div>
                `;

                suboptionEl.addEventListener('click', () => {
                    const selectedItem = {
                        ...item,
                        name: `${item.name} (${suboption.name})`,
                        price: item.price + suboption.price
                    };
                    addToOrder(selectedItem);
                    document.body.removeChild(suboptionsContainer);
                    isSuboptionsOpen = false; // Reset flag when a selection is made
                });

                suboptionsContainer.appendChild(suboptionEl);
            });

            document.body.appendChild(suboptionsContainer);
            
            // Add click event listener to close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeOutside(event) {
                    // Check if the click was outside the suboptions container
                    if (!suboptionsContainer.contains(event.target)) {
                        // Remove the container from the document
                        if (document.body.contains(suboptionsContainer)) {
                            document.body.removeChild(suboptionsContainer);
                        }
                        // Reset the flag
                        isSuboptionsOpen = false;
                        // Remove this event listener
                        document.removeEventListener('click', closeOutside);
                    }
                });
            }, 100); // Small delay to prevent immediate closing
        }

        
        // Add to order
        function addToOrder(item) {
            const existingItem = currentOrder.find(i => i.id === item.id);
            
            if (existingItem) {
                existingItem.quantity++;
                debug(`Increased quantity of ${item.name} to ${existingItem.quantity}`);
            } else {
                currentOrder.push({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: 1
                });
                debug(`Added new item: ${item.name}`);
            }
            
            updateOrderDisplay();
            updateSendButtonState(); 
        }
        
        // Update order display
        function updateOrderDisplay() {
            const orderItems = document.getElementById('orderItems');
            const emptyMessage = document.getElementById('emptyMessage');
            const totalAmount = document.getElementById('totalAmount');
            const sendOrderBtn = document.getElementById('sendOrderBtn');
            
            debug(`Updating order display with ${currentOrder.length} items`);
            
            // Clear previous items
            orderItems.innerHTML = '';
            
            if (currentOrder.length === 0) {
                if (emptyMessage) {
                    orderItems.appendChild(emptyMessage);
                }
                totalAmount.textContent = 'RSD0.00';
                sendOrderBtn.disabled = true;
                return;
            }
            
            let total = 0;
            
            // Add each item
            currentOrder.forEach((item, index) => {
                total += item.price * item.quantity;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'order-item';
                
                itemEl.innerHTML = `
                    <div class="order-item-name">
                        ${item.name} - RSD${item.price.toFixed(2)}
                        ${item.comment ? `<div class="item-comment">${item.comment}</div>` : ''}
                    </div>
                    <div class="order-item-controls">
                        <button class="btn" onclick="decreaseQuantity(${index})">-</button>
                        <span>${item.quantity}</span>
                        <button class="btn" onclick="increaseQuantity(${index})">+</button>
                        <button class="comment-btn" onclick="addComment(${index})">💬</button>
                        <button class="remove-btn" onclick="removeItem(${index})">×</button>
                    </div>
                `;
                
                orderItems.appendChild(itemEl);
            });
            
            totalAmount.textContent = 'RSD' + total.toFixed(2);
            sendOrderBtn.disabled = document.getElementById('tableSelect').value === '';
            
            debug(`Order display updated. Total: RSD${total.toFixed(2)}`);
        }
        
        // Increase quantity
        function increaseQuantity(index) {
            if (index >= 0 && index < currentOrder.length) {
                currentOrder[index].quantity++;
                debug(`Increased quantity of ${currentOrder[index].name} to ${currentOrder[index].quantity}`);
                updateOrderDisplay();
            }
        }
        
        // Decrease quantity
        function decreaseQuantity(index) {
            if (index >= 0 && index < currentOrder.length) {
                currentOrder[index].quantity--;
                
                if (currentOrder[index].quantity <= 0) {
                    removeItem(index);
                } else {
                    debug(`Decreased quantity of ${currentOrder[index].name} to ${currentOrder[index].quantity}`);
                    updateOrderDisplay();
                }
            }
        }
        
        // Remove item
        function removeItem(index) {
            if (index >= 0 && index < currentOrder.length) {
                const name = currentOrder[index].name;
                currentOrder.splice(index, 1);
                debug(`Removed item: ${name}`);
                updateOrderDisplay();
            }
        }

        const tableAreaSelect = document.getElementById('tableAreaSelect');
        const tableSelect = document.getElementById('tableSelect');

        tableAreaSelect.addEventListener('change', function() {
            const selectedArea = this.value;
            
            // Reset and hide the table select if no area is selected
            if (!selectedArea) {
                tableSelect.style.display = 'none';
                tableSelect.value = '';
                document.getElementById('sendOrderBtn').disabled = true;
                return;
            }
            
            // Populate the table select with tables from the selected area
            tableSelect.innerHTML = '<option value="">Izaberi sto</option>';
            
            tableMappings[selectedArea].forEach(table => {
                const option = document.createElement('option');
                option.value = table.value;
                option.textContent = table.label;
                tableSelect.appendChild(option);
            });
            
            // Show the table select
            tableSelect.style.display = 'block';
            tableSelect.value = '';
            
            // Update send button state
            updateSendButtonState();
        });

        // Update the table select event listener
        tableSelect.addEventListener('change', function() {
            debug('Table selection changed: ' + this.value);
            updateSendButtonState();
        });

        // Replace the updateSendButtonState function with this improved version
        function updateSendButtonState() {
            const sendOrderBtn = document.getElementById('sendOrderBtn');
            // Check both conditions: items in order AND table selected
            const tableValue = document.getElementById('tableSelect').value;
            const hasItems = currentOrder.length > 0;
            const hasTable = tableValue !== "";
            
            // Only enable if both conditions are met
            sendOrderBtn.disabled = !(hasItems && hasTable);
            
            // Debug info
            debug(`Button state: hasItems=${hasItems}, hasTable=${hasTable}, tableValue="${tableValue}", disabled=${sendOrderBtn.disabled}`);
        }

        // Current comment item index
        let currentCommentIndex = -1;

        // Add comment to order item
        function addComment(index) {
            if (index < 0 || index >= currentOrder.length) return;
            
            currentCommentIndex = index;
            const item = currentOrder[index];
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'comment-modal';
            modal.id = 'commentModal';
            
            modal.innerHTML = `
                <div class="comment-modal-content">
                    <div class="comment-modal-header">
                        <span>Add Comment for ${item.name}</span>
                        <span class="comment-close" onclick="closeCommentModal()">&times;</span>
                    </div>
                    <textarea class="comment-textarea" id="commentText" placeholder="Add special instructions...">${item.comment || ''}</textarea>
                    <div class="comment-buttons">
                        <button class="comment-cancel" onclick="closeCommentModal()">Cancel</button>
                        <button class="comment-save" onclick="saveComment()">Save</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus the textarea
            setTimeout(() => {
                document.getElementById('commentText').focus();
            }, 100);
            
            debug(`Opening comment modal for item ${index}: ${item.name}`);
        }

        // Close comment modal
        function closeCommentModal() {
            const modal = document.getElementById('commentModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            currentCommentIndex = -1;
            
            // Reset the zoom level
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                
                // Force redraw to apply zoom reset
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 50);
            }
        }

        // Save comment
        function saveComment() {
            if (currentCommentIndex < 0) return;
            
            const commentText = document.getElementById('commentText').value.trim();
            currentOrder[currentCommentIndex].comment = commentText;
            
            debug(`Saved comment for item ${currentCommentIndex}: ${commentText}`);
            
            // Close modal
            closeCommentModal();
            
            // Update display
            updateOrderDisplay();
        }
        // Send order
        // Send order
        // Send order
        async function sendOrder() {
            const tableSelect = document.getElementById('tableSelect');
            const tableNumber = tableSelect.value;

            if (currentOrder.length === 0) {
                alert('Please add items to your order');
                return;
            }

            if (!tableNumber) {
                alert('Please select a table');
                return;
            }

            const authToken = localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            
            debug(`Auth info - Token: ${authToken ? authToken.substring(0, 10) + '...' : 'none'}, Role: ${userRole}`);
            
            if (!authToken) {
                debug('No auth token found, redirecting to login');
                alert('Your session has expired. Please log in again.');
                localStorage.removeItem('userRole');
                window.location.href = '/work/login?role=waiter';
                return;
            }

            try {
                // Create new order object
                const order = {
                    table: tableNumber,
                    items: currentOrder.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        comment: item.comment || '' // Add this line
                    })),
                    status: 'pending'
                };

                debug(`Sending order data: ${JSON.stringify(order)}`);

                // Send order to the backend server
                const response = await fetch(`${CONFIG.baseUrl}/api/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-auth-token': authToken
                },
                body: JSON.stringify(order)
            });


                // Try to parse response as JSON
                let errorData;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    errorData = await response.json();
                } else {
                    const text = await response.text();
                    debug(`Non-JSON response: ${text}`);
                    errorData = { msg: text };
                }

                if (!response.ok) {
                    throw new Error(errorData.msg || 'Failed to send order to the server');
                }

                debug(`Order saved to MongoDB: ${JSON.stringify(errorData)}`);

                // Reset current order
                currentOrder = [];
                tableSelect.value = '';
                updateOrderDisplay();

                // Show success message
                showMessage('Order sent to bar successfully!');
            } catch (error) {
                console.error('Error sending order:', error);
                showMessage(`Error sending order: ${error.message}`, true);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            debug('Waiter dashboard loaded');
            
            // Check login
            const userRole = localStorage.getItem('userRole');
            if (!userRole || userRole !== 'waiter') {
                debug('Not authenticated as waiter');
                window.location.href = '/work';
                return;
            }
            
            debug('Authenticated as waiter');
            
            // Load default menu
            loadMenuItems('toceno');
            
            // Setup category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadMenuItems(this.dataset.category);
                });
            });
            
            // Setup table select
            document.getElementById('tableSelect').addEventListener('change', function() {
                document.getElementById('sendOrderBtn').disabled = currentOrder.length === 0 || this.value === '';
                debug('Table selection changed: ' + this.value);
            });
            
            // Setup send button
            document.getElementById('sendOrderBtn').addEventListener('click', sendOrder);
        });



        // Order tracking variables
        let sentOrdersCount = 0;
        let preparedOrdersCount = 0;
        
        // Update order stats display
        function updateOrderStats() {
            const sentElement = document.getElementById('sentOrdersCount');
            const preparedElement = document.getElementById('preparedOrdersCount');
            
            if (sentElement) sentElement.textContent = sentOrdersCount;
            if (preparedElement) preparedElement.textContent = preparedOrdersCount;
            
            debug(`Updated order stats: Sent=${sentOrdersCount}, Prepared=${preparedOrdersCount}`);
        }
        
        // Load order stats from backend or use localStorage with fallback
        async function loadOrderStats() {
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    debug('No auth token found, cannot load order stats');
                    return;
                }
                
                // With this logic instead:
                const now = new Date();
                let businessDay;

                // If it's before 3 AM, consider it part of the previous day
                if (now.getHours() < 3) {
                    businessDay = new Date(now.getTime() - 24 * 60 * 60 * 1000); // Subtract 1 day
                } else {
                    businessDay = now;
                }

                const today = businessDay.toISOString().split('T')[0];
                
                // Try to load actual orders to count statuses
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/orders`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': authToken
                        }
                    });
                    
                    if (response.ok) {
                        const orders = await response.json();
                        
                        // Filter to only today's orders and count sent and prepared
                        let sent = 0;
                        let prepared = 0;
                        
                        orders.forEach(order => {
                            const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                            
                            // Only count orders from today
                            if (orderDate === today) {
                                // Count all today's orders as "sent"
                                sent++;
                                
                                // Only count completed orders as "prepared"
                                if (order.status === 'completed') {
                                    prepared++;
                                }
                            }
                        });
                        
                        sentOrdersCount = sent;
                        preparedOrdersCount = prepared;
                        
                        updateOrderStats();
                        debug(`Calculated TODAY'S order stats from actual orders: Sent=${sent}, Prepared=${prepared}`);
                        
                        return;
                    }
                } catch (err) {
                    debug(`Error loading orders: ${err.message}`);
                }
                
                // Fall back to localStorage if needed
                const storedStats = JSON.parse(localStorage.getItem('orderStats') || '{"sent":0,"prepared":0}');
                sentOrdersCount = storedStats.sent || 0;
                preparedOrdersCount = storedStats.prepared || 0;
                updateOrderStats();
                
            } catch (error) {
                debug(`Error in loadOrderStats: ${error.message}`);
                const storedStats = JSON.parse(localStorage.getItem('orderStats') || '{"sent":0,"prepared":0}');
                sentOrdersCount = storedStats.sent || 0;
                preparedOrdersCount = storedStats.prepared || 0;
                updateOrderStats();
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('authToken');
            window.location.href = '/work';
        }
        
        // Initialize Socket.io to listen for order status updates
        let socket;
        
        // Initialize Socket.io to listen for order status updates
        function initializeSocket() {
            if (!window.io) {
                debug('Socket.io not available');
                return;
            }
            
            debug('Setting up Socket.io connection');
            socket = io(CONFIG.baseUrl);
            
            socket.on('connect', () => {
                debug('Socket.io connected');
                
                // Join waiter room to receive updates
                socket.emit('join', 'waiter');
                debug('Joined waiter room');
            });
            
            socket.on('order_status_updated', (updatedOrder) => {
                debug(`Order status updated: ${JSON.stringify(updatedOrder)}`);
                
                if (updatedOrder.status === 'completed') {
                    preparedOrdersCount++;
                    updateOrderStats();
                    
                    // Store updated stats in localStorage
                    localStorage.setItem('orderStats', JSON.stringify({
                        sent: sentOrdersCount,
                        prepared: preparedOrdersCount
                    }));
                    
                    // Show message bar notification
                    showMessage(`Order #${updatedOrder.number || ''} for Table ${updatedOrder.table} is ready!`);
                    
                    // Also show a persistent notification
                    showCompletedOrderNotification(updatedOrder);
                    
                    // Play a sound to alert the waiter
                    try {
                        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                        audio.play();
                    } catch (e) {
                        debug('Unable to play notification sound: ' + e.message);
                    }
                }
            });
            
            // When a new order is sent, update the sent count
            socket.on('order_received', (newOrder) => {
                debug(`New order acknowledged by system: ${JSON.stringify(newOrder)}`);
                // The sent count is already incremented when we send the order
            });
            
            socket.on('connect_error', (error) => {
                debug('Socket.io connection error: ' + error.message);
            });
            
            socket.on('disconnect', () => {
                debug('Socket.io disconnected');
                
                // Attempt to reconnect
                setTimeout(() => {
                    debug('Attempting to reconnect Socket.io');
                    socket.connect();
                }, 5000);
            });
        }
        // Modify the sendOrder function to update the sent count
        async function sendOrder() {
            const tableSelect = document.getElementById('tableSelect');
            const tableNumber = tableSelect.value;

            if (currentOrder.length === 0) {
                alert('Please add items to your order');
                return;
            }

            if (!tableNumber) {
                alert('Please select a table');
                return;
            }

            const authToken = localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            
            debug(`Auth info - Token: ${authToken ? authToken.substring(0, 10) + '...' : 'none'}, Role: ${userRole}`);
            
            if (!authToken) {
                debug('No auth token found, redirecting to login');
                alert('Your session has expired. Please log in again.');
                localStorage.removeItem('userRole');
                window.location.href = '/work/login?role=waiter';
                return;
            }

            try {
                // Create new order object
                const order = {
                    table: tableNumber,
                    items: currentOrder.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        comment: item.comment || ''
                    })),
                    status: 'pending'
                };

                debug(`Sending order data: ${JSON.stringify(order)}`);

                // Send order to the backend server
                const response = await fetch(`${CONFIG.baseUrl}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': authToken
                    },
                    body: JSON.stringify(order)
                });

                // Try to parse response as JSON
                let responseData;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    const text = await response.text();
                    debug(`Non-JSON response: ${text}`);
                    responseData = { msg: text };
                }

                if (!response.ok) {
                    throw new Error(responseData.msg || 'Failed to send order to the server');
                }

                debug(`Order saved to MongoDB: ${JSON.stringify(responseData)}`);

                // Increment the sent orders count
                sentOrdersCount++;
                updateOrderStats();

                // Store updated stats
                localStorage.setItem('orderStats', JSON.stringify({
                    sent: sentOrdersCount,
                    prepared: preparedOrdersCount
                }));

                // Reset current order
                currentOrder = [];
                tableSelect.value = '';
                updateOrderDisplay();

                // Show success message
                showMessage('Order sent to bar successfully!');
            } catch (error) {
                console.error('Error sending order:', error);
                showMessage(`Error sending order: ${error.message}`, true);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            debug('Waiter dashboard loaded');
            
            // Check login
            const userRole = localStorage.getItem('userRole');
            if (!userRole || userRole !== 'waiter') {
                debug('Not authenticated as waiter');
                window.location.href = '/work';
                return;
            }
            
            debug('Authenticated as waiter');
            
            // Load order stats
            loadOrderStats();

            // Load today's orders immediately
            loadTodaysOrders();
            
            // Initialize socket for real-time updates
            initializeSocket();
            
            // Load default menu
            loadMenuItems('toceno');
            
            // Setup category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadMenuItems(this.dataset.category);
                });
            });
            
            // Setup table select
            document.getElementById('tableSelect').addEventListener('change', function() {
                document.getElementById('sendOrderBtn').disabled = currentOrder.length === 0 || this.value === '';
                debug('Table selection changed: ' + this.value);
            });
            
            // Setup send button
            document.getElementById('sendOrderBtn').addEventListener('click', sendOrder);
            
            setInterval(() => {
                loadOrderStats();
                loadTodaysOrders();
            }, 3000);
        });    


        // Toggle dropdown menu
        function toggleMenu() {
            const dropdown = document.getElementById('dropdownContent');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.menu-btn')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
        // Update loadTodaysOrders to only fetch new orders
        let lastOrderId = null; // Track the last order we've seen
        let displayedOrders = new Set(); // Track which orders we've already displayed

        function loadTodaysOrders() {
            const authToken = localStorage.getItem('authToken');
            const todaysOrdersList = document.getElementById('todaysOrdersList');
            
            if (!todaysOrdersList) return;
            
            // Only show loading on first load
            if (displayedOrders.size === 0) {
                todaysOrdersList.innerHTML = '<div style="text-align: center; padding: 20px;">Učitavanje porudžbina...</div>';
            }
            
            const now = new Date();
            let businessDay;

            // If it's before 3 AM, consider it part of the previous day
            if (now.getHours() < 3) {
                businessDay = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            } else {
                businessDay = now;
            }

            const today = businessDay.toISOString().split('T')[0];
            
            fetch(`${CONFIG.baseUrl}/api/orders`, {
                method: 'GET',
                headers: {
                    'x-auth-token': authToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(orders => {
                const waiterOrders = orders.filter(order => {
                    const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                    return orderDate === today;
                });
                
                updateTodaysOrdersDisplay(waiterOrders);
            })
            .catch(error => {
                console.error('Error loading today\'s orders:', error);
                if (todaysOrdersList && displayedOrders.size === 0) {
                    todaysOrdersList.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Greška pri učitavanju porudžbina</div>';
                }
            });
        }

        // New function to update orders without full reload
        function updateTodaysOrdersDisplay(orders) {
            const todaysOrdersList = document.getElementById('todaysOrdersList');
            if (!todaysOrdersList) return;
            
            if (orders.length === 0) {
                if (displayedOrders.size === 0) {
                    todaysOrdersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nema pronađenih porudžbina za danas</div>';
                }
                return;
            }
            
            // Sort orders by creation time (newest first)
            orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // If this is the first load, display all orders
            if (displayedOrders.size === 0) {
                displayedOrders.clear();
                todaysOrdersList.innerHTML = '';
                
                orders.forEach(order => {
                    addOrderToDisplay(order, todaysOrdersList);
                    displayedOrders.add(order._id);
                });
                return;
            }
            
            // Check for new orders and add them to the top
            const newOrders = orders.filter(order => !displayedOrders.has(order._id));
            
            if (newOrders.length > 0) {
                // Add new orders to the top of the list
                newOrders.reverse().forEach(order => { // Reverse to maintain newest-first order
                    addOrderToDisplay(order, todaysOrdersList, true); // true = prepend
                    displayedOrders.add(order._id);
                });
                
                debug(`Added ${newOrders.length} new orders to display`);
            }
            
            // Update existing orders' status if changed
            updateExistingOrdersStatus(orders);
        }

        // Function to add a single order to the display
        function addOrderToDisplay(order, container, prepend = false) {
            const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderTime = new Date(order.createdAt).toLocaleTimeString();
            
            const itemsHtml = order.items.map(item => {
                const itemTotal = item.price * item.quantity;
                return `
                    <div style="display: flex; justify-content: space-between; padding: 2px 0; font-size: 12px;">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>RSD${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
            
            const statusColors = {
                pending: '#f39c12',
                sent: '#ff9800', 
                prepared: '#2196F3',
                completed: '#4CAF50'
            };
            
            const orderElement = document.createElement('div');
            orderElement.setAttribute('data-order-id', order._id);
            orderElement.style.cssText = 'border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; padding: 10px; background-color: #f9f9f9;';
            
            orderElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: bold; font-size: 14px;">
                        Sto ${order.table} - #${order._id.slice(-6)}
                    </div>
                    <div class="order-status-badge" style="padding: 2px 8px; border-radius: 8px; font-size: 10px; color: white; background-color: ${statusColors[order.status] || '#ccc'};">
                        ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                    </div>
                </div>
                
                <div style="margin-bottom: 8px;">
                    ${itemsHtml}
                </div>
                
                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                    <span style="color: #666;">${orderTime}</span>
                    <span style="font-weight: bold;">RSD${total.toFixed(2)}</span>
                </div>
            `;
            
            if (prepend) {
                container.insertBefore(orderElement, container.firstChild);
            } else {
                container.appendChild(orderElement);
            }
        }

        // Function to update status of existing orders without full reload
        function updateExistingOrdersStatus(orders) {
            orders.forEach(order => {
                const orderElement = document.querySelector(`[data-order-id="${order._id}"]`);
                if (orderElement) {
                    const statusBadge = orderElement.querySelector('.order-status-badge');
                    if (statusBadge) {
                        const statusColors = {
                            pending: '#f39c12',
                            sent: '#ff9800', 
                            prepared: '#2196F3',
                            completed: '#4CAF50'
                        };
                        
                        statusBadge.style.backgroundColor = statusColors[order.status] || '#ccc';
                        statusBadge.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
                    }
                }
            });
        }
    </script>
</body>
</html>